#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

// Read the generated TypeScript types
const typesFile = path.join(__dirname, '../src/generated/IssueTracker.ts');
const typesContent = fs.readFileSync(typesFile, 'utf8');

// Simple parsing to extract model information
// This is a basic implementation - in a real scenario you'd use TypeScript compiler API

const models = {};
let currentModel = null;

// Very basic parsing - look for model definitions
const lines = typesContent.split('\n');
for (let i = 0; i < lines.length; i++) {
  const line = lines[i].trim();

  if (line.startsWith('export type') && line.includes('= {')) {
    const modelName = line.split(' ')[2].toLowerCase();
    if (modelName === 'issue' || modelName === 'project') {
      currentModel = modelName;
      models[currentModel] = {};
    }
  } else if (currentModel && line.includes(':') && !line.includes('{') && !line.includes('}')) {
    // Parse field definitions like "title: string,"
    const fieldMatch = line.match(/(\w+):\s*([^;]+)/);
    if (fieldMatch) {
      const fieldName = fieldMatch[1];
      let fieldType = fieldMatch[2].replace(/[;?]/g, '');

      // Convert TypeScript types to Tinybase types
      let tinybaseType = 'string';
      if (fieldType.includes('number')) {
        tinybaseType = 'number';
      }

      // Skip id fields as Tinybase handles them automatically
      if (fieldName !== 'id') {
        models[currentModel][fieldName] = {
          type: tinybaseType,
          default: getDefaultValue(tinybaseType)
        };
      }
    }
  } else if (line.includes('}')) {
    currentModel = null;
  }
}

function getDefaultValue(type) {
  switch (type) {
    case 'string': return '""';
    case 'number': return 0;
    default: return '""';
  }
}

// Generate Tinybase schema
const schemaContent = `// Auto-generated Tinybase schema from TypeSpec
// Generated by generate-tinybase-schema.js

export const tinybaseSchema = ${JSON.stringify(models, null, 2)} as const;

// Type-safe schema access
export type TinybaseSchema = typeof tinybaseSchema;

// Helper to create Tinybase store configuration
export function createTinybaseConfig() {
  return {
    tables: tinybaseSchema
  };
}
`;

const outputFile = path.join(__dirname, '../src/generated/tinybase-schema.ts');
fs.writeFileSync(outputFile, schemaContent);

console.log('âœ… Generated Tinybase schema at:', outputFile);